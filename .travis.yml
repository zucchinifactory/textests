language: generic
before_install:
  - |
    if [ "$TRAVIS_EVENT_TYPE" == "push" ] ; then
      echo "This build belongs to a git push where [ci autotag] has been detected in the commit message."
      echo "Build #$TRAVIS_BUILD_NUMBER will be canceled and a tag will be pushed to trigger a new build and the release deployment instead."
      echo "Set email and name..."
      git config --global user.email "deploy@travis-ci.org"
      git config --global user.name "Deployment Bot (from Travis CI)"
      echo "Create tag..."
      export GIT_TAG=${TRAVIS_BRANCH}_$(date --utc "+%Y-%m-%d-%H-%M-%S")
      git tag "thisisthetesttag" -a -m "This tag has been auto-generated by Travis CI build #$TRAVIS_BUILD_NUMBER."
      echo "Push commit with tag $GIT_TAG..."
      git push "https://$GITHUB_TOKEN@github.com/$TRAVIS_REPO_SLUG" "$GIT_TAG"
      echo "Installing CLI tool..."
      gem install travis
      echo "Logging in via token..."
      travis login --org --github-token "$GITHUB_TOKEN"
      echo "Cancel build #$TRAVIS_BUILD_NUMBER..."
      travis cancel "$TRAVIS_BUILD_NUMBER"
      sleep infinity
    fi
  - sudo apt-get -qq update
  - sudo apt-get install -qq -y texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra latexmk
script:
  - make
deploy:
  - provider: releases
    skip_cleanup: true
    api_key: $GITHUB_TOKEN
    file_glob: true
    file:
      - "*.pdf"
    overwrite: true
    on:
      tags: true
